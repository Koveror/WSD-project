{# This page is shows an individual game embedded in an iframe#}

<!DOCTYPE HTML>
<html>
  <head>
    <title>GameDetail</title>

    <script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
    <script>

        window.addEventListener("message", receiveMessage, false);

        //This function receives the messages sent by the game in the iframe below
        function receiveMessage(event)
        {
            if(event.origin !== "") {
              //FIXME: Only execute messages from trustworthy sources
            }
            message = JSON.stringify(event.data);
            console.log("Received object: " + message);

            if(event.data.messageType == "SAVE") {
              // using jQuery
              function getCookie(name) {
                  var cookieValue = null;
                  if (document.cookie && document.cookie !== '') {
                      var cookies = document.cookie.split(';');
                      for (var i = 0; i < cookies.length; i++) {
                          var cookie = jQuery.trim(cookies[i]);
                          // Does this cookie string begin with the name we want?
                          if (cookie.substring(0, name.length + 1) === (name + '=')) {
                              cookieValue =   decodeURIComponent(cookie.substring(name.length + 1));
                              break;
                          }
                      }
                  }
                  return cookieValue;
              }
              var csrftoken = getCookie('csrftoken');
              function csrfSafeMethod(method) {
                  // these HTTP methods do not require CSRF protection
                  return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
              }

              $.ajaxSetup({
                  beforeSend: function(xhr, settings) {
                      if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                          xhr.setRequestHeader("X-CSRFToken", csrftoken);
                      }
                  }
              });

              $.ajax({
                type: "POST",
                url: "{% url 'hello:save_game' game.gameid %}",
                data: JSON.stringify(event.data),
                dataType: "json"
              }).done(function(save_message) {
                alert(save_message.message);
              });
            }
        }

    </script>
  </head>
  <body>

    <h1>GameDetails for {{game}}</h1>

    {#Any game can be added to a page in an iframe like this#}
    <iframe src="http://webcourse.cs.hut.fi/example_game.html"></iframe>

    <form action="{% url 'hello:save_game' game.gameid %}" method="post" id="save_form">
      {% csrf_token %}
    </form>

    <ul class="actions">
      <li><a href="home" class="button">Home</a></li>
      <li><a href="gamelist" class="button">Gamelist</a></li>
      <li><a href="shop" class="button">Shop</a></li>
      <li><a href="#" class="button">High scores</a></li>
    </ul>

    <button id="logout">Logout</button>

  </body>